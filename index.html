<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Warung Miekopies Bali (Online)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden; 
            font-family: 'Segoe UI', sans-serif; 
            background-color: #f3f4f6;
            -webkit-user-select: none;
            user-select: none;
            touch-action: manipulation;
        }

        .hide { display: none !important; }
        .show { display: flex !important; }
        
        .page-container {
            width: 100%; 
            height: 100dvh; 
            display: flex;
            flex-direction: column;
            position: absolute; 
            top: 0; left: 0;
            background-color: #f3f4f6;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        ::-webkit-scrollbar { width: 3px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .category-btn.active {
            background-color: #2563eb; color: white; border-color: #2563eb;
        }

        .filter-btn.active {
            background-color: #7e22ce; color: white; border-color: #7e22ce;
        }
        
        .receipt-paper {
            background: white;
            position: relative;
            box-shadow: 0 1px 4px rgba(0,0,0,0.1);
        }
        .receipt-dashed {
            border-bottom: 2px dashed #cbd5e1;
        }

        .calc-btn {
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            font-size: 1.25rem;
            font-weight: bold;
            color: #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
            transition: transform 0.1s;
        }
        .calc-btn:active {
            transform: scale(0.95);
            background-color: #f3f4f6;
        }
        
        /* Edit Mode Indicator */
        .edit-mode-banner {
            background: #f59e0b;
            color: white;
            text-align: center;
            font-size: 0.7rem;
            padding: 2px;
            font-weight: bold;
        }
    </style>
</head>
<body>

    <!-- 1. LOBBY -->
    <div id="view-lobby" class="page-container show bg-gray-900 z-50">
        <div class="flex-1 flex flex-col items-center justify-center p-6 text-white text-center overflow-y-auto">
            <div class="mb-6 flex-none">
                <h1 class="text-3xl font-extrabold text-yellow-400 mb-1">WARUNG MIEKOPIES</h1>
                <p class="text-gray-400 text-sm">Nusadua Bali • <span class="text-green-400 font-bold">ONLINE</span></p>
            </div>

            <div class="grid grid-cols-2 gap-3 w-full max-w-sm flex-none">
                <!-- Mulai Jualan -->
                <button onclick="navigate('view-cashier')" class="col-span-2 bg-blue-600 hover:bg-blue-700 p-4 rounded-xl shadow-lg flex items-center gap-3 transition transform active:scale-95 text-left">
                    <div class="bg-blue-800 p-3 rounded-full w-10 h-10 flex items-center justify-center">
                        <i class="fas fa-cash-register text-lg"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-base">Mulai Jualan</h3>
                        <p class="text-[10px] text-blue-200">Buka Kasir Menu</p>
                    </div>
                </button>

                <!-- FITUR BARU: MENU STOK -->
                <button onclick="navigate('view-stock')" class="bg-indigo-600 hover:bg-indigo-700 p-4 rounded-xl shadow-lg flex flex-col items-center gap-2 transition transform active:scale-95 text-center justify-center">
                    <i class="fas fa-boxes text-2xl mb-1"></i>
                    <h3 class="font-bold text-sm">Stok</h3>
                </button>

                <!-- Laporan -->
                <button onclick="navigate('view-database')" class="bg-purple-600 hover:bg-purple-700 p-4 rounded-xl shadow-lg flex flex-col items-center gap-2 transition transform active:scale-95 text-center justify-center">
                    <i class="fas fa-file-invoice text-2xl mb-1"></i>
                    <h3 class="font-bold text-sm">Laporan</h3>
                </button>

                <!-- Kasir Manual -->
                <button onclick="navigate('view-calculator')" class="bg-teal-600 hover:bg-teal-700 p-4 rounded-xl shadow-lg flex flex-col items-center gap-2 transition transform active:scale-95 text-center justify-center">
                    <i class="fas fa-calculator text-2xl mb-1"></i>
                    <h3 class="font-bold text-xs">Manual</h3>
                </button>

                <!-- Kelola Menu -->
                <button onclick="navigate('view-admin')" class="bg-orange-600 hover:bg-orange-700 p-4 rounded-xl shadow-lg flex flex-col items-center gap-2 transition transform active:scale-95 text-center justify-center">
                    <i class="fas fa-utensils text-2xl mb-1"></i>
                    <h3 class="font-bold text-xs">Kelola Menu</h3>
                </button>
            </div>
            
            <p class="mt-8 text-xs text-gray-600 flex-none">App v11.0 (Full Features)</p>
        </div>
    </div>

    <!-- 2. KASIR (POS) -->
    <div id="view-cashier" class="page-container hide">
        <div id="edit-mode-indicator" class="edit-mode-banner hidden">MODE EDIT TRANSAKSI</div>
        <div class="bg-white shadow-sm z-10 flex-none w-full">
            <div class="flex items-center justify-between px-4 py-2 border-b">
                <button onclick="navigate('view-lobby')" class="text-gray-600 hover:text-gray-900 active:scale-90 transition p-2">
                    <i class="fas fa-home text-lg"></i>
                </button>
                <div class="flex items-center gap-2">
                    <!-- FITUR BARU: SORTING -->
                    <button onclick="window.toggleSort()" class="text-gray-600 text-xs font-bold border border-gray-200 bg-gray-50 px-2 py-1 rounded flex items-center gap-1">
                        <i class="fas fa-sort"></i> <span id="sort-label">Default</span>
                    </button>
                    <button onclick="navigate('view-calculator')" class="text-teal-600 text-xs font-bold border border-teal-200 bg-teal-50 px-2 py-1 rounded">
                        <i class="fas fa-calculator"></i>
                    </button>
                </div>
            </div>
            <!-- Category Tabs Dynamic -->
            <div class="flex gap-2 p-2 overflow-x-auto whitespace-nowrap bg-gray-100" id="cashier-cat-tabs">
                <!-- Rendered by JS -->
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-2 bg-gray-50 relative" id="pos-menu-grid">
            <div id="loading-menu" class="text-center mt-10 text-gray-400 text-xs hidden">
                <i class="fas fa-circle-notch fa-spin"></i> Memuat Menu...
            </div>
            <div class="grid grid-cols-3 gap-2 pb-10" id="menu-grid-container"></div>
        </div>

        <div class="bg-white border-t rounded-t-2xl shadow-[0_-5px_20px_rgba(0,0,0,0.1)] z-20 flex-none h-[35%] flex flex-col w-full">
            <div class="p-2 border-b bg-gray-50 flex items-center gap-2 flex-none">
                <i class="fas fa-user-circle text-gray-400 text-lg"></i>
                <input type="text" id="buyer-name" placeholder="Nama Pelanggan..." class="flex-1 bg-transparent outline-none text-sm font-bold text-gray-700 h-8">
                <button onclick="window.clearCart()" class="text-xs text-red-500 font-bold px-3 py-1 bg-red-50 rounded hover:bg-red-100 border border-red-200 active:scale-95 transition">
                    <i class="fas fa-trash-alt mr-1"></i> Reset
                </button>
            </div>
            <div class="flex-1 overflow-y-auto p-3" id="cart-list">
                <p class="text-center text-gray-400 text-xs mt-4 italic">Belum ada pesanan</p>
            </div>
            <div class="p-3 bg-gray-800 text-white flex justify-between items-center flex-none pb-safe"> 
                <div>
                    <p class="text-[10px] text-gray-400">Total Tagihan</p>
                    <p class="text-lg font-bold text-yellow-400" id="cart-total">Rp 0</p>
                </div>
                <button onclick="window.showBillPreview()" id="btn-main-pay" class="bg-green-500 hover:bg-green-600 text-white px-5 py-2 rounded-lg font-bold shadow-lg transition transform active:scale-95 flex items-center gap-2 text-sm">
                    Bayar <i class="fas fa-chevron-right text-[10px]"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 3. KELOLA MENU (ADMIN) - UPDATE TILE -->
    <div id="view-admin" class="page-container hide bg-gray-100">
        <div class="bg-white p-4 shadow-sm z-10 flex-none flex items-center justify-between">
            <div class="flex items-center gap-3">
                <button onclick="navigate('view-lobby')" class="text-gray-600 active:scale-90 transition p-2"><i class="fas fa-arrow-left text-xl"></i></button>
                <h2 class="font-bold text-lg">Kelola Menu</h2>
            </div>
            <button onclick="window.seedDefaultMenus()" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded border border-blue-200">
                <i class="fas fa-cloud-upload-alt"></i> Default
            </button>
        </div>

        <div class="flex-1 overflow-y-auto p-4 pb-20">
            <div class="bg-white p-4 rounded-xl shadow mb-4">
                <h3 class="font-bold text-gray-700 mb-3 text-sm">Tambah / Edit Menu</h3>
                
                <!-- FITUR BARU: CATEGORY TILES DI ADMIN -->
                <div class="flex gap-2 overflow-x-auto mb-3 pb-1" id="admin-cat-tiles">
                    <!-- Rendered by JS -->
                </div>

                <div class="space-y-3">
                    <input type="text" id="new-menu-name" placeholder="Nama Menu (ex: Mie Setan)" class="w-full p-2 text-sm border rounded focus:border-blue-500 outline-none">
                    <div class="flex gap-2">
                        <input type="number" id="new-menu-price" placeholder="Harga" class="w-1/2 p-2 text-sm border rounded outline-none">
                        <!-- Input Stok Awal -->
                        <input type="number" id="new-menu-stock" placeholder="Stok Awal" class="w-1/2 p-2 text-sm border rounded outline-none" value="100">
                    </div>
                    <!-- Hidden input untuk menyimpan kategori yang dipilih via Tile -->
                    <input type="hidden" id="selected-admin-cat" value="makanan">
                    
                    <button onclick="window.addNewMenu()" class="w-full bg-blue-600 text-white py-2 rounded font-bold text-sm hover:bg-blue-700 active:scale-95 transition">
                        <i class="fas fa-save"></i> Simpan ke Cloud
                    </button>
                </div>
            </div>

            <h3 class="font-bold text-gray-600 text-xs mb-2 px-1">Daftar Menu (Filter: <span id="admin-filter-label">Semua</span>)</h3>
            <div class="space-y-2" id="admin-menu-list">
                <div class="text-center mt-4 text-gray-400 text-xs"><i class="fas fa-circle-notch fa-spin"></i> Sinkronisasi...</div>
            </div>
        </div>
    </div>

    <!-- 4. MANAJEMEN STOK (FITUR BARU) -->
    <div id="view-stock" class="page-container hide bg-gray-100">
        <div class="bg-indigo-700 text-white p-4 shadow-sm z-10 flex-none flex items-center justify-between">
            <div class="flex items-center gap-3">
                <button onclick="navigate('view-lobby')" class="text-white active:scale-90 transition p-2"><i class="fas fa-arrow-left text-xl"></i></button>
                <h2 class="font-bold text-lg">Manajemen Stok</h2>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-4 pb-20">
            <div class="space-y-2" id="stock-list">
                <!-- Render Stok -->
            </div>
        </div>
    </div>

    <!-- 5. DATABASE (LAPORAN) -->
    <div id="view-database" class="page-container hide bg-white">
        <div class="bg-purple-800 text-white p-4 shadow-md flex-none z-10">
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                    <button onclick="navigate('view-lobby')" class="active:scale-90 transition p-1"><i class="fas fa-arrow-left text-xl"></i></button>
                    <h2 class="font-bold text-lg">Laporan</h2>
                </div>
                <div class="text-right">
                    <p class="text-[10px] opacity-80" id="report-period-label">Total Omzet</p>
                    <p class="font-bold text-lg" id="report-grand-total">Rp 0</p>
                </div>
            </div>
            <div class="flex gap-2 overflow-x-auto pb-1" id="report-filters">
                <button onclick="window.setReportFilter('today')" class="filter-btn active px-3 py-1 rounded-full text-xs font-semibold border border-purple-300 bg-white text-purple-700 transition whitespace-nowrap">Hari Ini</button>
                <button onclick="window.setReportFilter('yesterday')" class="filter-btn px-3 py-1 rounded-full text-xs font-semibold border border-purple-300 bg-white text-purple-700 transition whitespace-nowrap">Kemarin</button>
                <button onclick="window.setReportFilter('month')" class="filter-btn px-3 py-1 rounded-full text-xs font-semibold border border-purple-300 bg-white text-purple-700 transition whitespace-nowrap">Bulan Ini</button>
                <div class="relative">
                    <input type="date" id="custom-date-picker" onchange="window.setReportFilter('custom', this.value)" class="absolute opacity-0 w-full h-full cursor-pointer">
                    <button class="filter-btn px-3 py-1 rounded-full text-xs font-semibold border border-purple-300 bg-white text-purple-700 transition whitespace-nowrap flex items-center gap-1">
                        <i class="fas fa-calendar-alt"></i> Tanggal
                    </button>
                </div>
            </div>
        </div>
        <div class="flex-1 overflow-y-auto p-2 bg-gray-50 pb-20" id="transaction-list">
             <div class="text-center mt-10 text-gray-400 text-xs"><i class="fas fa-circle-notch fa-spin"></i> Mengambil Data...</div>
        </div>
    </div>

    <!-- 6. KASIR MANUAL -->
    <div id="view-calculator" class="page-container hide bg-gray-100">
        <div class="bg-white p-3 shadow-sm flex items-center gap-3 flex-none">
            <button onclick="navigate('view-lobby')" class="text-gray-600 p-2"><i class="fas fa-times text-xl"></i></button>
            <h2 class="font-bold text-lg">Kasir Manual</h2>
        </div>
        <div class="flex-1 flex flex-col p-3 w-full overflow-hidden">
            <div class="flex-1 overflow-y-auto mb-2 border border-gray-200 bg-white rounded-lg p-2" id="manual-history-list">
                <p class="text-center text-gray-400 text-xs mt-4">Belum ada item manual</p>
            </div>
            <div class="flex-none flex flex-col gap-2">
                <div class="bg-white p-3 rounded-xl shadow-sm text-right border border-gray-200">
                    <p class="text-[10px] text-gray-400">Input Harga Baru</p>
                    <div class="text-3xl font-bold text-gray-800" id="calc-display">0</div>
                </div>
                <div class="grid grid-cols-4 gap-2 h-[40vh] max-h-[300px]">
                    <button onclick="appendCalc('7')" class="calc-btn">7</button>
                    <button onclick="appendCalc('8')" class="calc-btn">8</button>
                    <button onclick="appendCalc('9')" class="calc-btn">9</button>
                    <button onclick="clearCalc()" class="calc-btn text-red-500 bg-red-50 border-red-100">C</button>
                    <button onclick="appendCalc('4')" class="calc-btn">4</button>
                    <button onclick="appendCalc('5')" class="calc-btn">5</button>
                    <button onclick="appendCalc('6')" class="calc-btn">6</button>
                    <button onclick="backspaceCalc()" class="calc-btn text-orange-500"><i class="fas fa-backspace"></i></button>
                    <button onclick="appendCalc('1')" class="calc-btn">1</button>
                    <button onclick="appendCalc('2')" class="calc-btn">2</button>
                    <button onclick="appendCalc('3')" class="calc-btn">3</button>
                    <button onclick="addToManualList()" class="calc-btn row-span-2 bg-blue-100 text-blue-600 border-blue-200 hover:bg-blue-200 active:bg-blue-300 text-sm flex-col gap-1">
                        <i class="fas fa-plus text-lg"></i> <span class="text-[10px]">ADD</span>
                    </button>
                    <button onclick="appendCalc('0')" class="calc-btn col-span-2">0</button>
                    <button onclick="appendCalc('00')" class="calc-btn">00</button>
                </div>
            </div>
        </div>
        <div id="manual-footer" class="p-3 bg-white border-t flex-none hidden pb-safe">
            <button onclick="finishManualSession()" class="w-full bg-green-600 text-white py-3 rounded-xl font-bold shadow-lg flex justify-between px-6 items-center active:scale-95 transition">
                <span>Masuk Keranjang</span> <span id="manual-total-display">Rp 0</span>
            </button>
        </div>
    </div>

    <!-- MODAL STRUK -->
    <div id="bill-modal" class="fixed inset-0 bg-black bg-opacity-80 hidden z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-sm rounded-lg shadow-2xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-gray-100 p-3 flex justify-between items-center border-b">
                <h3 class="font-bold text-gray-700">Detail Transaksi</h3>
                <button onclick="window.closeBillModal()" class="text-gray-500 hover:text-gray-800 p-2"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto bg-white receipt-paper font-mono text-sm" id="bill-content"></div>
            
            <div id="payment-actions" class="p-4 bg-gray-50 border-t grid grid-cols-2 gap-3 hidden">
                <button onclick="window.processPayment('TUNAI')" class="bg-green-100 border border-green-500 text-green-700 py-3 rounded-lg font-bold hover:bg-green-200 flex flex-col items-center active:scale-95 transition">
                    <span>TUNAI</span> <span class="text-[10px] font-normal">Cash</span>
                </button>
                <button onclick="window.processPayment('HUTANG')" class="bg-red-100 border border-red-500 text-red-700 py-3 rounded-lg font-bold hover:bg-red-200 flex flex-col items-center active:scale-95 transition">
                    <span>HUTANG</span> <span class="text-[10px] font-normal">Bon/Credit</span>
                </button>
            </div>
            
             <div id="view-actions" class="p-4 bg-gray-50 border-t hidden flex flex-col gap-2">
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="window.sendToWA()" class="bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-700 flex items-center justify-center gap-2 shadow-sm active:scale-95 transition">
                        <i class="fab fa-whatsapp text-xl"></i> Kirim WA
                    </button>
                    <button onclick="window.saveReceiptImage()" class="bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 flex items-center justify-center gap-2 shadow-sm active:scale-95 transition">
                        <i class="fas fa-download"></i> Simpan
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-2 mt-1">
                    <!-- FITUR BARU: EDIT TRANSAKSI -->
                    <button onclick="window.editTransaction()" class="w-full bg-yellow-50 text-yellow-600 border border-yellow-200 py-2 rounded-lg font-bold hover:bg-yellow-100 flex items-center justify-center gap-2 active:scale-95 transition text-sm">
                        <i class="fas fa-edit"></i> Edit / Revisi
                    </button>
                    <button onclick="window.deleteTransaction()" class="w-full bg-red-50 text-red-600 border border-red-200 py-2 rounded-lg font-bold hover:bg-red-100 flex items-center justify-center gap-2 active:scale-95 transition text-sm">
                        <i class="fas fa-trash-alt"></i> Hapus
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODULE SCRIPT UNTUK FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, orderBy, onSnapshot, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAWi2L7bJewUmTeR_SwGM0sdwjFLdOisCs",
            authDomain: "kasir-128a2.firebaseapp.com",
            projectId: "kasir-128a2",
            storageBucket: "kasir-128a2.firebasestorage.app",
            messagingSenderId: "566922594063",
            appId: "1:566922594063:web:c251d0943a0e20ab51a07a",
            measurementId: "G-NM9MSXY677"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // STATE
        let menus = [];
        let categories = []; // Dinamis dari Firestore
        let transactions = [];
        let cart = [];
        let currentCategory = 'all';
        let currentViewedTrx = null;
        let calcValue = "0";
        let manualSessionCart = [];
        let reportFilterMode = 'today';
        let reportFilterDate = null;
        let sortMode = 'default'; // default, name_asc, price_high, price_low
        let editingTransactionId = null; // ID transaksi yang sedang diedit

        // --- FETCH KATEGORI ---
        // Jika belum ada kategori di DB, buat default
        const catCol = collection(db, "categories");
        onSnapshot(catCol, async (snapshot) => {
            if (snapshot.empty) {
                // Seed default categories
                const defaultCats = ["Makanan", "Minuman", "Camilan", "Tambahan"];
                for (const c of defaultCats) {
                    await addDoc(catCol, { name: c, id: c.toLowerCase() });
                }
            } else {
                categories = snapshot.docs.map(doc => ({ uid: doc.id, ...doc.data() }));
                renderCategoryTiles(); // Update UI
            }
        });

        // --- FETCH MENU ---
        const menuCol = collection(db, "menus");
        onSnapshot(menuCol, (snapshot) => {
            menus = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if(!document.getElementById('view-cashier').classList.contains('hide')) renderMenuGrid();
            if(!document.getElementById('view-admin').classList.contains('hide')) renderAdminList();
            if(!document.getElementById('view-stock').classList.contains('hide')) renderStockList();
            document.getElementById('loading-menu').classList.add('hidden');
        });

        // --- FETCH TRANSAKSI ---
        const trxCol = collection(db, "transactions");
        const qTrx = query(trxCol, orderBy("timestamp", "desc"));
        onSnapshot(qTrx, (snapshot) => {
            transactions = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if(!document.getElementById('view-database').classList.contains('hide')) renderTransactions();
        });

        // --- WINDOW FUNCTIONS ---
        
        window.navigate = function(viewId) {
            document.querySelectorAll('.page-container').forEach(el => {
                el.classList.remove('show');
                el.classList.add('hide');
            });
            document.getElementById(viewId).classList.remove('hide');
            document.getElementById(viewId).classList.add('show');

            if(viewId === 'view-cashier') renderMenuGrid();
            if(viewId === 'view-admin') {
                renderCategoryTiles();
                renderAdminList();
            }
            if(viewId === 'view-database') window.setReportFilter('today');
            if(viewId === 'view-stock') renderStockList();
            
            // Jika keluar dari kasir dan TIDAK sedang edit mode, reset
            if(viewId !== 'view-cashier' && viewId !== 'view-calculator') {
               // Jangan reset cart jika sedang pindah ke kalkulator
            }
            
            // Jika meninggalkan kasir sepenuhnya (misal ke lobby) dan BUKAN edit mode
            if (viewId === 'view-lobby') {
                if (editingTransactionId) {
                    if(!confirm("Batalkan edit transaksi?")) {
                        window.navigate('view-cashier'); // Batal keluar
                        return;
                    }
                    exitEditMode();
                }
            }
        }

        // --- LOGIKA KATEGORI DINAMIS (TILES) ---
        function renderCategoryTiles() {
            // Render untuk Kasir, Admin, dan Stok (bisa reuse logic)
            const cashierTabs = document.getElementById('cashier-cat-tabs');
            const adminTabs = document.getElementById('admin-cat-tiles');
            
            // Build HTML
            let html = `<button onclick="window.setCategory('all')" class="category-btn ${currentCategory === 'all' ? 'active' : ''} px-4 py-1.5 rounded-full text-xs font-semibold border border-gray-300 bg-white text-gray-600 transition whitespace-nowrap">Semua</button>`;
            
            categories.forEach(cat => {
                const isActive = currentCategory === cat.name.toLowerCase();
                html += `<button onclick="window.setCategory('${cat.name.toLowerCase()}')" class="category-btn ${isActive ? 'active' : ''} px-4 py-1.5 rounded-full text-xs font-semibold border border-gray-300 bg-white text-gray-600 transition whitespace-nowrap">${cat.name}</button>`;
            });

            // Tombol Tambah Kategori di Admin
            let adminHtml = html + `<button onclick="window.addCategoryPrompt()" class="px-3 py-1.5 rounded-full text-xs font-bold bg-green-100 text-green-600 border border-green-200 whitespace-nowrap"><i class="fas fa-plus"></i></button>`;

            if(cashierTabs) cashierTabs.innerHTML = html;
            if(adminTabs) adminTabs.innerHTML = adminHtml;
        }

        window.setCategory = function(cat) {
            currentCategory = cat;
            renderCategoryTiles(); // Re-render untuk update class active
            renderMenuGrid();
            renderAdminList(); // Filter list admin juga
            
            // Update hidden input di admin jika ada
            const adminHidden = document.getElementById('selected-admin-cat');
            if(adminHidden && cat !== 'all') adminHidden.value = cat;
        }

        window.addCategoryPrompt = async function() {
            const { value: catName } = await Swal.fire({
                title: 'Tambah Kategori',
                input: 'text',
                inputLabel: 'Nama Kategori Baru',
                showCancelButton: true
            });

            if (catName) {
                await addDoc(collection(db, "categories"), { name: catName, id: catName.toLowerCase() });
                Swal.fire('Sukses', 'Kategori ditambahkan', 'success');
            }
        }

        // --- LOGIKA SORTIR ---
        window.toggleSort = function() {
            // Cycle: default -> name -> price high -> price low
            const label = document.getElementById('sort-label');
            if(sortMode === 'default') { sortMode = 'name_asc'; label.innerText = "Nama A-Z"; }
            else if(sortMode === 'name_asc') { sortMode = 'price_high'; label.innerText = "Termahal"; }
            else if(sortMode === 'price_high') { sortMode = 'price_low'; label.innerText = "Termurah"; }
            else { sortMode = 'default'; label.innerText = "Default"; }
            
            renderMenuGrid();
        }

        function getSortedMenus(menuList) {
            let sorted = [...menuList];
            if(sortMode === 'name_asc') sorted.sort((a,b) => a.name.localeCompare(b.name));
            if(sortMode === 'price_high') sorted.sort((a,b) => b.price - a.price);
            if(sortMode === 'price_low') sorted.sort((a,b) => a.price - b.price);
            return sorted;
        }

        // --- MANAJEMEN STOK ---
        function renderStockList() {
            const list = document.getElementById('stock-list');
            list.innerHTML = '';
            
            menus.forEach(item => {
                const el = document.createElement('div');
                el.className = 'bg-white p-3 rounded-lg shadow-sm border border-gray-200 flex justify-between items-center';
                // Stok default 0 jika undefined
                const currentStock = item.stock !== undefined ? item.stock : 0;
                
                el.innerHTML = `
                    <div>
                        <div class="font-bold text-gray-800">${item.name}</div>
                        <div class="text-xs text-gray-500">${item.category}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="window.updateStock('${item.id}', -1)" class="w-8 h-8 bg-red-100 text-red-600 rounded flex items-center justify-center font-bold">-</button>
                        <span class="w-10 text-center font-bold text-lg">${currentStock}</span>
                        <button onclick="window.updateStock('${item.id}', 1)" class="w-8 h-8 bg-green-100 text-green-600 rounded flex items-center justify-center font-bold">+</button>
                    </div>
                `;
                list.appendChild(el);
            });
        }

        window.updateStock = async function(docId, change) {
            // Optimistic Update (UI dulu baru DB) bisa, tapi kita langsung DB aja biar aman
            const item = menus.find(m => m.id === docId);
            const newStock = (item.stock || 0) + change;
            if(newStock < 0) return; // Gak boleh minus

            await setDoc(doc(db, "menus", docId), { stock: newStock }, { merge: true });
        }

        // --- FITUR EDIT TRANSAKSI ---
        window.editTransaction = function() {
            if(!currentViewedTrx) return;
            
            // 1. Set Flag Edit
            editingTransactionId = currentViewedTrx.id;
            
            // 2. Load Items ke Cart
            cart = JSON.parse(JSON.stringify(currentViewedTrx.items)); // Deep copy
            document.getElementById('buyer-name').value = currentViewedTrx.buyer;
            
            // 3. UI Changes
            document.getElementById('edit-mode-indicator').classList.remove('hidden');
            document.getElementById('btn-main-pay').innerHTML = 'Simpan Revisi <i class="fas fa-save ml-1"></i>';
            document.getElementById('btn-main-pay').classList.remove('bg-green-500');
            document.getElementById('btn-main-pay').classList.add('bg-yellow-500');
            
            // 4. Navigate to Cashier
            window.closeBillModal();
            window.navigate('view-cashier');
            renderCart();
            
            Swal.fire({
                title: 'Mode Edit',
                text: 'Silakan ubah item, tambah, atau kurangi. Klik Simpan Revisi jika selesai.',
                icon: 'info',
                timer: 2000,
                showConfirmButton: false
            });
        }

        function exitEditMode() {
            editingTransactionId = null;
            document.getElementById('edit-mode-indicator').classList.add('hidden');
            document.getElementById('btn-main-pay').innerHTML = 'Bayar <i class="fas fa-chevron-right text-[10px]"></i>';
            document.getElementById('btn-main-pay').classList.add('bg-green-500');
            document.getElementById('btn-main-pay').classList.remove('bg-yellow-500');
            document.getElementById('buyer-name').value = '';
            cart = [];
            renderCart();
        }

        // --- UPDATE FUNGSI PEMBAYARAN (HANDLE EDIT & STOK) ---
        window.processPayment = async function(method) {
            const buyer = document.getElementById('buyer-name').value.trim() || "Pelanggan";
            const total = cart.reduce((sum, i) => sum + (i.price * i.qty), 0);
            
            Swal.fire({title: 'Memproses...', didOpen: () => Swal.showLoading()});

            try {
                // 1. Kurangi Stok (Loop cart)
                // Hanya kurangi stok jika ini transaksi BARU. 
                // Jika EDIT, logikanya rumit (harus balikin stok lama dulu). 
                // UNTUK SIMPLIFIKASI V11: Stok hanya berkurang saat Transaksi Baru. Edit tidak mengubah stok otomatis (manual adjust di menu stok).
                if (!editingTransactionId) {
                    for (const item of cart) {
                        if (!item.isManual && item.id) {
                            // Cari item di menu asli untuk cek stok
                            const menuItem = menus.find(m => m.id === item.id);
                            if (menuItem) {
                                const newStock = (menuItem.stock || 0) - item.qty;
                                await setDoc(doc(db, "menus", item.id), { stock: newStock }, { merge: true });
                            }
                        }
                    }
                }

                // 2. Simpan Transaksi
                if (editingTransactionId) {
                    // UPDATE Existing Doc
                    await setDoc(doc(db, "transactions", editingTransactionId), {
                        buyer: buyer,
                        items: cart,
                        total: total,
                        method: method,
                        // Timestamp tidak diubah agar posisi di laporan tetap
                        updatedAt: Date.now()
                    }, { merge: true });
                    
                    Swal.fire({icon: 'success', title: 'Revisi Disimpan', timer: 1500, showConfirmButton: false});
                    exitEditMode();
                } else {
                    // CREATE New Doc
                    await addDoc(collection(db, "transactions"), {
                        buyer: buyer,
                        items: cart,
                        total: total,
                        method: method,
                        timestamp: Date.now(),
                        date: new Date().toLocaleString('id-ID')
                    });
                    
                    Swal.fire({icon: 'success', title: 'Transaksi Berhasil', timer: 1500, showConfirmButton: false});
                    cart = [];
                    document.getElementById('buyer-name').value = '';
                    renderCart();
                }

                window.closeBillModal();
                
            } catch (e) {
                console.error(e);
                Swal.fire('Error', 'Gagal menyimpan transaksi', 'error');
            }
        }

        // --- RENDERERS ---
        function renderMenuGrid() {
            const container = document.getElementById('menu-grid-container');
            container.innerHTML = '';
            
            let filteredMenus = currentCategory === 'all' ? menus : menus.filter(m => {
                // Handle case sensitivity & matching
                return (m.category || '').toLowerCase() === currentCategory;
            });

            // Apply Sorting
            filteredMenus = getSortedMenus(filteredMenus);

            if(filteredMenus.length === 0) {
                 container.innerHTML = '<p class="col-span-3 text-center text-gray-400 mt-10 text-xs">Kosong</p>';
                return;
            }

            filteredMenus.forEach(item => {
                const el = document.createElement('div');
                const stockDisplay = item.stock !== undefined ? `<span class="text-[10px] ${item.stock < 5 ? 'text-red-500 font-bold' : 'text-gray-400'}">Stok: ${item.stock}</span>` : '';
                
                el.className = `menu-card ${item.color || 'bg-white'} p-2 rounded-lg shadow-sm border border-gray-100 flex flex-col items-center justify-center cursor-pointer h-28 text-center transition active:scale-95`;
                el.onclick = () => window.addToCart(item.id);
                el.innerHTML = `
                    <i class="fas ${item.icon || 'fa-utensils'} text-xl mb-1 text-gray-700 opacity-70"></i>
                    <h4 class="font-bold text-[10px] leading-tight text-gray-800 line-clamp-2 h-6 flex items-center justify-center overflow-hidden w-full">${item.name}</h4>
                    <p class="text-xs text-blue-700 font-bold mt-0.5">Rp ${item.price.toLocaleString('id-ID')}</p>
                    ${stockDisplay}
                `;
                container.appendChild(el);
            });
        }

        function renderAdminList() {
            const list = document.getElementById('admin-menu-list');
            list.innerHTML = '';
            
            // Filter Admin List berdasarkan kategori yang dipilih di atas
            const filteredAdminMenus = currentCategory === 'all' ? menus : menus.filter(m => (m.category || '').toLowerCase() === currentCategory);
            
            document.getElementById('admin-filter-label').innerText = currentCategory === 'all' ? 'Semua' : currentCategory;

            filteredAdminMenus.forEach((item) => {
                const row = document.createElement('div');
                row.className = 'bg-white border rounded p-3 flex justify-between items-center shadow-sm mb-2';
                row.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center text-gray-500 bg-gray-100"><i class="fas ${item.icon}"></i></div>
                        <div>
                            <div class="font-bold text-sm text-gray-800">${item.name}</div>
                            <div class="text-xs text-gray-500">${item.category} • Stok: ${item.stock || 0}</div>
                        </div>
                    </div>
                    <button onclick="window.deleteMenu('${item.id}')" class="text-red-500 px-3 py-2 bg-red-50 rounded-lg hover:bg-red-100 transition active:scale-95"><i class="fas fa-trash"></i></button>
                `;
                list.appendChild(row);
            });
        }

        // --- EXISTING FUNCTIONS (Unchanged Logic, just re-declared) ---
        // Include: addToCart, updateQty, clearCart, addNewMenu, deleteMenu, deleteTransaction...
        // Saya persingkat penulisannya di sini karena logika sama persis v10, 
        // tapi di file asli harus ditulis lengkap.
        
        window.addToCart = function(itemId) {
            const item = menus.find(m => m.id === itemId);
            if(!item) return;
            // Cek stok saat mau beli (Optional: Block jika 0)
            if(item.stock !== undefined && item.stock <= 0) {
                Swal.fire({toast: true, position: 'center', icon: 'warning', title: 'Stok Habis!', timer: 1000, showConfirmButton: false});
                return;
            }
            const existing = cart.find(c => c.id === item.id);
            if(existing) existing.qty++;
            else cart.push({ ...item, qty: 1 });
            renderCart();
        }

        window.updateQty = function(idx, change) {
            cart[idx].qty += change;
            if(cart[idx].qty <= 0) cart.splice(idx, 1);
            renderCart();
        }

        window.clearCart = function() {
            if(cart.length > 0 && confirm("Hapus pesanan?")) {
                cart = [];
                renderCart();
                // Jika sedang edit mode, keluar? Tidak, biarkan user isi ulang.
            }
        }

        window.addNewMenu = async function() {
            const name = document.getElementById('new-menu-name').value;
            const price = document.getElementById('new-menu-price').value;
            // Ambil stok awal
            const stock = document.getElementById('new-menu-stock').value;
            // Ambil kategori dari hidden input (yang diset via Tile) atau fallback ke select
            let cat = document.getElementById('selected-admin-cat').value;
            if(!cat || cat === 'all') cat = 'makanan'; // Default fallback

            if(!name || !price) return Swal.fire('Error', 'Data belum lengkap', 'error');

            let icon = 'fa-utensils';
            let color = 'bg-white';
            // Simple icon logic based on cat string
            if(cat.includes('minum')) { icon = 'fa-glass-water'; color = 'bg-blue-50'; }
            if(cat.includes('camil')) { icon = 'fa-bread-slice'; color = 'bg-yellow-50'; }
            
            Swal.fire({title: 'Menyimpan...', didOpen: () => Swal.showLoading()});

            try {
                await addDoc(collection(db, "menus"), {
                    name: name, 
                    price: parseInt(price), 
                    category: cat, // Simpan string kategori
                    icon: icon, 
                    color: color,
                    stock: parseInt(stock) || 0
                });
                document.getElementById('new-menu-name').value = '';
                document.getElementById('new-menu-price').value = '';
                Swal.fire({icon: 'success', title: 'Tersimpan', timer: 1000, showConfirmButton: false});
            } catch (e) {
                Swal.fire('Error', 'Gagal simpan', 'error');
            }
        }

        window.deleteMenu = async function(docId) {
            if(confirm('Hapus menu ini?')) {
                await deleteDoc(doc(db, "menus", docId));
            }
        }

        window.deleteTransaction = async function() {
            if(!currentViewedTrx) return;
            if(confirm('Hapus transaksi ini permanen?')) {
                await deleteDoc(doc(db, "transactions", currentViewedTrx.id));
                window.closeBillModal();
            }
        }

        // --- CALCULATOR LOGIC ---
        window.appendCalc = function(val) {
            if(calcValue === "0") calcValue = val; else calcValue += val;
            document.getElementById('calc-display').innerText = parseInt(calcValue).toLocaleString('id-ID');
        }
        window.clearCalc = function() {
            calcValue = "0";
            document.getElementById('calc-display').innerText = "0";
        }
        window.backspaceCalc = function() {
            if(calcValue.length > 1) calcValue = calcValue.slice(0, -1); else calcValue = "0";
            document.getElementById('calc-display').innerText = parseInt(calcValue).toLocaleString('id-ID');
        }
        window.addToManualList = function() {
            const price = parseInt(calcValue);
            if(price <= 0) return;
            manualSessionCart.push({ price: price, id: Date.now() });
            window.clearCalc();
            renderManualHistory();
        }
        function renderManualHistory() {
            const container = document.getElementById('manual-history-list');
            const footer = document.getElementById('manual-footer');
            const totalDisplay = document.getElementById('manual-total-display');
            if(manualSessionCart.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 text-xs mt-10">Kosong</p>';
                footer.classList.add('hidden');
                return;
            }
            let html = '';
            let total = 0;
            [...manualSessionCart].reverse().forEach((item, index) => {
                total += item.price;
                html += `<div class="flex justify-between p-2 border-b"><span class="text-sm">Manual #${manualSessionCart.length - index}</span><span class="font-bold">Rp ${item.price.toLocaleString('id-ID')}</span></div>`;
            });
            container.innerHTML = html;
            totalDisplay.innerText = 'Rp ' + total.toLocaleString('id-ID');
            footer.classList.remove('hidden');
        }
        window.finishManualSession = function() {
            if(manualSessionCart.length === 0) return;
            manualSessionCart.forEach(m => {
                cart.push({ id: 'manual_' + m.id, name: "Item Manual", price: m.price, qty: 1, isManual: true });
            });
            manualSessionCart = [];
            window.navigate('view-cashier');
            renderCart();
        }

        // --- LAPORAN RENDERER (SAMA DENGAN V10) ---
        function renderTransactions() {
            const list = document.getElementById('transaction-list');
            const totalEl = document.getElementById('report-grand-total');
            const labelEl = document.getElementById('report-period-label');
            list.innerHTML = '';
            
            const now = new Date();
            let filteredTrx = transactions;
            let filterLabel = "Semua";

            if (reportFilterMode === 'today') {
                const todayStr = now.toLocaleDateString('id-ID');
                filteredTrx = transactions.filter(t => new Date(t.timestamp).toLocaleDateString('id-ID') === todayStr);
                filterLabel = "Hari Ini";
            } else if (reportFilterMode === 'yesterday') {
                const yest = new Date(now); yest.setDate(yest.getDate() - 1);
                const yestStr = yest.toLocaleDateString('id-ID');
                filteredTrx = transactions.filter(t => new Date(t.timestamp).toLocaleDateString('id-ID') === yestStr);
                filterLabel = "Kemarin";
            } else if (reportFilterMode === 'month') {
                filteredTrx = transactions.filter(t => {
                    const d = new Date(t.timestamp);
                    return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
                });
                filterLabel = "Bulan Ini";
            } else if (reportFilterMode === 'custom' && reportFilterDate) {
                const selStr = new Date(reportFilterDate).toLocaleDateString('id-ID');
                filteredTrx = transactions.filter(t => new Date(t.timestamp).toLocaleDateString('id-ID') === selStr);
                filterLabel = selStr;
            }

            labelEl.innerText = "Omzet " + filterLabel;

            if(filteredTrx.length === 0) {
                list.innerHTML = '<p class="text-center text-gray-400 text-xs mt-10">Kosong</p>';
                totalEl.innerText = 'Rp 0';
                return;
            }

            let omzet = 0;
            filteredTrx.forEach(trx => {
                omzet += trx.total;
                const el = document.createElement('div');
                el.onclick = () => window.viewTransactionDetail(trx.id);
                el.className = `bg-white p-3 mb-2 rounded border-l-4 ${trx.method === 'HUTANG' ? 'border-red-500' : 'border-green-500'} cursor-pointer shadow-sm`;
                el.innerHTML = `
                    <div class="flex justify-between">
                        <span class="font-bold text-sm">${trx.buyer}</span>
                        <span class="text-xs text-gray-500">${trx.date}</span>
                    </div>
                    <div class="flex justify-between mt-1">
                        <span class="text-xs text-gray-500">${trx.items ? trx.items.length : 0} Item</span>
                        <span class="font-bold text-gray-800">Rp ${trx.total.toLocaleString('id-ID')}</span>
                    </div>
                `;
                list.appendChild(el);
            });
            totalEl.innerText = 'Rp ' + omzet.toLocaleString('id-ID');
        }

        window.setReportFilter = function(mode, val) {
            reportFilterMode = mode;
            if(val) reportFilterDate = val;
            
            const btns = document.querySelectorAll('.filter-btn');
            btns.forEach(b => b.classList.remove('active'));
            // Simple logic to activate button based on order/click (Simplified for v11)
            renderTransactions();
        }

        function renderCart() {
            const list = document.getElementById('cart-list');
            const totalEl = document.getElementById('cart-total');
            list.innerHTML = '';
            let total = 0;
            if(cart.length === 0) list.innerHTML = '<p class="text-center text-gray-400 text-xs mt-4">Kosong</p>';
            
            cart.forEach((item, index) => {
                total += item.price * item.qty;
                const row = document.createElement('div');
                row.className = 'flex justify-between items-center mb-2 bg-white p-2 rounded border border-gray-100';
                row.innerHTML = `
                    <div><div class="font-bold text-xs">${item.name}</div><div class="text-[10px]">${item.qty} x ${item.price.toLocaleString()}</div></div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-xs">Rp ${(item.price * item.qty).toLocaleString()}</span>
                        <div class="flex items-center bg-gray-100 rounded">
                             <button onclick="window.updateQty(${index}, -1)" class="w-7 h-7 text-red-500 font-bold">-</button>
                             <button onclick="window.updateQty(${index}, 1)" class="w-7 h-7 text-blue-500 font-bold">+</button>
                        </div>
                    </div>
                `;
                list.appendChild(row);
            });
            totalEl.innerText = 'Rp ' + total.toLocaleString('id-ID');
        }

        // STRUK HELPERS
        window.viewTransactionDetail = function(id) {
            const trx = transactions.find(t => t.id === id);
            if(!trx) return;
            currentViewedTrx = trx;
            document.getElementById('bill-content').innerHTML = generateReceiptHTML(trx.buyer, trx.items, trx.total, trx.date, trx.method);
            document.getElementById('payment-actions').classList.add('hidden');
            document.getElementById('payment-actions').classList.remove('grid');
            document.getElementById('view-actions').classList.remove('hidden');
            document.getElementById('view-actions').classList.add('flex');
            document.getElementById('bill-modal').classList.remove('hidden');
        }
        
        window.closeBillModal = function() {
            document.getElementById('bill-modal').classList.add('hidden');
        }

        function generateReceiptHTML(buyer, items, total, date, method) {
            let itemHtml = '';
            (items || []).forEach(i => {
                itemHtml += `<div class="flex justify-between text-xs mb-1"><span>${i.name} x${i.qty}</span><span>${(i.price*i.qty).toLocaleString()}</span></div>`;
            });
            return `
                <div class="p-2 text-center">
                    <h2 class="font-bold">WARUNG MIEKOPIES</h2>
                    <p class="text-xs text-gray-500 mb-2">${date}</p>
                    <div class="text-left border-t border-b py-2 border-dashed my-2 space-y-1">
                        <div class="flex justify-between font-bold text-xs"><span>Plg: ${buyer}</span><span>${method}</span></div>
                        ${itemHtml}
                    </div>
                    <div class="flex justify-between font-bold text-lg"><span>TOTAL</span><span>Rp ${total.toLocaleString()}</span></div>
                </div>
            `;
        }

        window.sendToWA = function() {
            if(!currentViewedTrx) return;
            const t = currentViewedTrx;
            let text = `*Struk Miekopies*\nTgl: ${t.date}\nPlg: ${t.buyer}\n`;
            t.items.forEach(i => text += `${i.name} (${i.qty}) : ${i.price*i.qty}\n`);
            text += `*Total: ${t.total}*\nMetode: ${t.method}`;
            window.location.href = `https://wa.me/?text=${encodeURIComponent(text)}`;
        }
        
        window.saveReceiptImage = function() {
            const el = document.getElementById('bill-content');
            html2canvas(el, {scale:2, backgroundColor:'#fff'}).then(c => {
                const l = document.createElement('a'); l.download = 'struk.png'; l.href = c.toDataURL(); l.click();
            });
        }

        window.seedDefaultMenus = async function() {
            // Helper seeding (sama spt v10)
            Swal.fire('Info', 'Gunakan menu Tambah Kategori dulu', 'info');
        }

    </script>
</body>
</html>

